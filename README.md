# MpesaLib [![mpesalib MyGet Build Status](https://www.myget.org/BuildSource/Badge/mpesalib?identifier=cf0f8e5c-2a40-41cf-8065-9f27db7e2678)](https://www.myget.org/)
 
MPESA API LIBRARY For C# Developers

* MpesaLib is in BETA Version as of NUGET Package version 1.0.8.
* MpesaLib is based on .NET Standard 2.0
* MpesaLib is a side project, and is fully open source.
* Pull requests and design reviews/recommendations are encouraged.

Explore All existing MPESA APIs and how to generate your API Keys at Daraja - [Safaricom's Developer Portal](https://developer.safaricom.co.ke/apis-explorer)

## Note
* *Access tokens generated by the [Authclient](https://github.com/ayiemba/MpesaLib/blob/master/src/MpesaLib/Clients/AuthClient.cs) expire after an hour (this is documented in Daraja).* 

![Accesstoken Expirition period](screenshots/accesstoken.png)

* *Users of MpesaLib should ensure they handle token expriration in their code. A quick solution would be to put the semaphore in a try/catch/finally block as documented in [this question](https://stackoverflow.com/questions/49304326/refresh-token-using-static-httpclient) from stackoverflow.*

## 1. HOW TO USE In an ASP.NET Core Web Application

* Run `Install-Package MpesaLib -Version 1.0.8` in Package Manager Console or go to Manage Nuget Packages, Search and install MpesaLib
* Inject Mpesa API Clients in DI Container; For asp.net core core this can be done in Startup.cs

```c#
    //Add AuthClient
    services.AddHttpClient<AuthClient>();
    //Add LipaNaMpesaOnlineClient
    services.AddHttpClient<LipaNaMpesaOnlineClient>();
    //Add C2BRegisterUrlClient
    services.AddHttpClient<C2BRegisterClient>();
    //Add C2BSimulateClient
    services.AddHttpClient<C2BSimulateClient>();
    //Add any other Mpesa API Clients you wish to use...
```

* In your Controller Instantiate the clients in constructor...

```c#
    public class PaymentsController : Controller
    {
        private readonly AuthClient _auth;
        private LipaNaMpesaOnlineClient _lipaNaMpesa;
        private C2BRegisterClient _c2bregister;
        private readonly C2BSimulateClient _c2bSimulate;
        private readonly IConfiguration _config;

        public PaymentsController(AuthClient auth, LipaNaMpesaOnlineClient lipaNampesa, C2BRegisterClient c2bregister,
           C2BSimulateClient c2bsim, IConfiguration configuration)
        {
            _auth = auth;
            _lipaNaMpesa = lipaNampesa;
            _c2bregister = c2bregister;
            _c2bSimulate = c2bsim;
            _config = configuration;
        }
        ...
        //Code omitted for brevity
```

* You can store your ConsumerKey and ConsumerSecret in appsettings.json as follows

```json
     "MpesaConfiguration": {
         "ConsumerKey": "[Your Mpesa ConsumerKey from daraja]",
         "ConsumerSecret": "[Your Mpesa ConsumerSecret from daraja]"
       }
```

* Generate `accesstoken` using the AuthClient

```c#
        // GET: /<controller>/
        public async Task<IActionResult> Index()
        {
            var consumerKey = _config["MpesaConfiguration:ConsumerKey"];

            var consumerSecret = _config["MpesaConfiguration:ConsumerSecret"];

            var accesstoken = await _auth.GetData(consumerKey,consumerSecret);
            
            ...
        //code omitted for brevity
```

* To use Send Request to LipaNaMpesaOnline, initialize the LipaNaMpesaOnline object by providing values for it's properties

```c#
      LipaNaMpesaOnline lipaonline = new LipaNaMpesaOnline
      {
          AccountReference = "test",
          Amount = "1",
          PartyA = "254708374149",
          PartyB = "174379",
          BusinessShortCode = "174379",
          CallBackURL = "[your callback url, i wish i could help but you'll have to write your own]",
          Password = "daraga explains on how to get password",
          PhoneNumber = "254708374149",
          Timestamp = "20180716124916",//DateTime.Now.ToString("yyyyMMddHHmmss"),
          TransactionDesc = "test"
          TransactionType = "CustomerPayBillOnline" //I am using this by default, you might wanna check the other option
      };
```

* You can then make a payment request in your controller as follows..

```c#
var paymentrequest = await _lipaNaMpesa.MakePayment(lipaonline, accesstoken);
```

* Do whatever you want with the results of the request... (Of cos i plan to make these docs better in the future)
